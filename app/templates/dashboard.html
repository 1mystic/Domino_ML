{% extends "base.html" %}

{% block title %}Dashboard - DominoML{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
    /* Additional utilities not in dashboard.css but needed for layout consistency */
    .flex {
        display: flex;
    }

    .items-center {
        align-items: center;
    }

    .justify-between {
        justify-content: space-between;
    }

    .gap-2 {
        gap: 0.5rem;
    }

    .gap-3 {
        gap: 0.75rem;
    }

    /* Dashboard Toggle Styles */
    .pill-nav-container {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }

    .pill-nav {
        display: inline-flex;
        background: hsl(var(--muted));
        padding: 0.25rem;
        border-radius: 9999px;
        position: relative;
        border: 1px solid hsl(var(--border));
    }

    .nav-pill-item {
        background: transparent;
        border: none;
        padding: 0.5rem 1.5rem;
        border-radius: 9999px;
        font-size: 0.9rem;
        font-weight: 500;
        color: hsl(var(--muted-foreground));
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .nav-pill-item.active {
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-weight: 600;
    }

    .nav-pill-item:hover:not(.active) {
        color: hsl(var(--foreground));
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container container">
    <!-- Header/Navbar -->
    <header class="header" style="margin-bottom: 2rem;">
        <div class="navbar flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="{{ url_for('main.landing') }}" class="flex items-center gap-2" style="text-decoration:none;">
                    <div class="logo-box" style="width:32px; height:32px;">
                        <img src="{{ url_for('static', filename='images/domino-icon.svg') }}" alt="DominoML logo"
                            class="logo-icon-img">
                    </div>
                    <h1 class="logo-text" style="font-size:1.25rem; margin:0;">DominoML</h1>
                </a>
            </div>
            <div class="flex items-center gap-3">
                <button id="theme-toggle" class="btn btn-ghost btn-sm" aria-label="Toggle theme">
                    <i data-lucide="moon" class="theme-icon"></i>
                </button>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-muted hide-mobile">{{ current_user.display_name or current_user.username
                        }}</span>
                    <div class="avatar-placeholder"
                        style="width:32px;height:32px;border-radius:50%;background:hsl(var(--primary));display:flex;align-items:center;justify-content:center;color:rgb(239, 170, 170);font-weight:600;">
                        {{ (current_user.display_name or current_user.username)[0].upper() }}
                    </div>
                    <a href="{{ url_for('auth.logout') }}" class="signout-btn" title="Sign Out">
                        <i data-lucide="log-out"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Header -->
    <header class="dashboard-header">
        <div class="flex items-center justify-between">
            <div>
                <h1>Overview</h1>
                <p class="welcome-text">Manage your pipelines and experiments</p>
            </div>
            <div class="quick-actions" style="display:flex; gap:1rem;">
                <button onclick="document.getElementById('joinClassModal').style.display='flex'"
                    class="btn btn-secondary">
                    <i data-lucide="log-in"></i>
                    Join Class
                </button>
                <a href="{{ url_for('main.gallery') }}" class="btn btn-outline" style="text-decoration:none;">
                    <i data-lucide="grid"></i>
                    Browse Gallery
                </a>
                <a href="{{ url_for('main.builder') }}" class="btn btn-primary"
                    style="text-decoration:none; color:hsl(var(--primary-foreground));">
                    <i data-lucide="plus"></i>
                    New Project
                </a>
            </div>
        </div>
    </header>

    <!-- Stats Row -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i data-lucide="graduation-cap"></i>
            </div>
            <div class="stat-content">
                <h3>Active Classes</h3>
                <div class="stat-value">{{ teaching|length + enrolled|length }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i data-lucide="box"></i>
            </div>
            <div class="stat-content">
                <h3>Total Models</h3>
                <div class="stat-value">{{ current_user.models.count() }}</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i data-lucide="activity"></i>
            </div>
            <div class="stat-content">
                <h3>Recent Activity</h3>
                <div class="stat-value">Active</div>
            </div>
        </div>
    </div>

    <!-- Toggle Switch -->
    <div class="pill-nav-container">
        <div class="pill-nav">
            <button class="nav-pill-item active" onclick="switchView('classrooms')">Classrooms</button>
            <button class="nav-pill-item" onclick="switchView('projects')">Projects</button>
        </div>
    </div>

    <!-- Classrooms Section -->
    <section id="classrooms-section" style="margin-bottom: 3rem;">
        <div class="section-header">
            <h2 class="section-title">Classrooms</h2>
            <div style="display:flex; gap:0.5rem;">
                <button onclick="document.getElementById('joinClassModal').style.display='flex'"
                    class="btn btn-outline btn-sm" style="font-size:0.8rem; padding:0.4rem 0.8rem;">
                    <i data-lucide="log-in" style="width:16px; height:16px;"></i> Join Class
                </button>
                <button onclick="document.getElementById('createClassModal').style.display='flex'"
                    class="btn btn-secondary btn-sm" style="font-size:0.8rem; padding:0.4rem 0.8rem;">
                    <i data-lucide="plus" style="width:16px; height:16px;"></i> Create Class
                </button>
            </div>
        </div>

        {% if teaching or enrolled %}
        <div class="models-grid">
            <!-- Teaching -->
            {% for class in teaching %}
            <div class="model-card">
                <div class="model-header">
                    <div class="model-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                        <i data-lucide="graduation-cap"></i>
                    </div>
                </div>
                <a href="{{ url_for('lms.classroom_view', class_id=class.id) }}" class="model-name">{{ class.name }}</a>
                <p class="model-desc">{{ class.section or "No section" }} â€¢ {{ class.description or "No description" }}
                </p>
                <div class="model-footer">
                    <a href="{{ url_for('lms.classroom_view', class_id=class.id) }}" class="model-action-btn btn-open">
                        Enter Class
                    </a>
                </div>
            </div>
            {% endfor %}

            <!-- Enrolled -->
            {% for class in enrolled %}
            <div class="model-card">
                <div class="model-header">
                    <div class="model-icon"
                        style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color:white;">
                        <i data-lucide="book-open"></i>
                    </div>
                </div>
                <a href="{{ url_for('lms.classroom_view', class_id=class.id) }}" class="model-name">{{ class.name }}</a>
                <p class="model-desc">By {{ class.owner.display_name or class.owner.username }}</p>
                <div class="model-footer">
                    <a href="{{ url_for('lms.classroom_view', class_id=class.id) }}" class="model-action-btn btn-view">
                        View Class
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="dashboard-empty">
            <span class="empty-icon">ðŸ“š</span>
            <h3 class="empty-title">No Classes Yet</h3>
            <p class="empty-text">Join a class using a code or create one to start teaching.</p>
        </div>
        {% endif %}
    </section>

    <!-- Projects Section -->
    <section id="projects-section" style="display: none;">
        <div class="section-header">
            <h2 class="section-title">Your Models</h2>
        </div>

        {% if current_user.models.count() > 0 %}
        <div class="models-grid">
            {% for model in current_user.models %}
            <div class="model-card">
                <div class="model-header">
                    <div class="model-icon">
                        <i data-lucide="workflow"></i>
                    </div>
                    <!-- Optional menu for delete/rename could go here -->
                </div>

                <a href="{{ url_for('main.builder', modelId=model.id) }}" class="model-name">{{ model.name }}</a>
                <p class="model-desc">{{ model.description or "No description provided." }}</p>

                <div class="model-stats">
                    <div class="model-stat" title="Created">
                        <i data-lucide="calendar"></i>
                        {{ model.created_at.strftime('%b %d, %Y') }}
                    </div>
                </div>

                <div class="model-footer">
                    <a href="{{ url_for('main.builder', modelId=model.id) }}" class="model-action-btn btn-open">
                        <i data-lucide="edit-3"></i>
                        Open
                    </a>
                    
                    <button onclick="confirmDelete({{ model.id }}, '{{ model.name }}')"
                        class="model-action-btn btn-delete" title="Delete Pipeline">
                        <i data-lucide="trash-2"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="dashboard-empty">
            <span class="empty-icon">ðŸ“‚</span>
            <h3 class="empty-title">No Models Yet</h3>
            <p class="empty-text">Create your first machine learning pipeline to get started.</p>
            <a href="{{ url_for('main.builder') }}" class="btn btn-primary"
                style="text-decoration:none; color:hsl(var(--primary-foreground));">
                <i data-lucide="plus"></i>
                Create Pipeline
            </a>
        </div>
        {% endif %}
    </section>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-modal" class="dialog-overlay" hidden>
    <div class="dialog">
        <div class="dialog-header">
            <h3>Delete Pipeline?</h3>
            <button class="dialog-close" onclick="closeDeleteModal()">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="dialog-content">
            <p>Are you sure you want to delete <strong id="delete-model-name"></strong>?</p>
            <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.9rem;">This action cannot be undone.</p>
        </div>
        <div class="dialog-footer">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button id="confirm-delete-btn" class="btn btn-danger">Delete</button>
        </div>
    </div>
</div>

<!-- Create Class Modal -->
<div id="createClassModal" class="dialog-overlay" style="display:none;">
    <div class="dialog">
        <form action="{{ url_for('lms.create_classroom') }}" method="POST">
            <div class="dialog-header">
                <h3>Create Class</h3>
                <button type="button" class="dialog-close"
                    onclick="document.getElementById('createClassModal').style.display='none'"><i
                        data-lucide="x"></i></button>
            </div>
            <div class="dialog-content">
                <div style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Class Name</label>
                    <input type="text" name="name" required
                        style="width:100%; padding:0.5rem; border:1px solid hsl(var(--border)); border-radius:0.25rem; background:hsl(var(--background)); color:hsl(var(--foreground));">
                </div>
                <div style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Section</label>
                    <input type="text" name="section"
                        style="width:100%; padding:0.5rem; border:1px solid hsl(var(--border)); border-radius:0.25rem; background:hsl(var(--background)); color:hsl(var(--foreground));">
                </div>
                <div style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Description</label>
                    <textarea name="description" rows="2"
                        style="width:100%; padding:0.5rem; border:1px solid hsl(var(--border)); border-radius:0.25rem; background:hsl(var(--background)); color:hsl(var(--foreground));"></textarea>
                </div>
            </div>
            <div class="dialog-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('createClassModal').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-primary"
                    style="background:hsl(var(--primary)); color:hsl(var(--primary-foreground));">Create</button>
            </div>
        </form>
    </div>
</div>

<!-- Join Class Modal -->
<div id="joinClassModal" class="dialog-overlay" style="display:none;">
    <div class="dialog">
        <form action="{{ url_for('lms.join_classroom') }}" method="POST">
            <div class="dialog-header">
                <h3>Join Class</h3>
                <button type="button" class="dialog-close"
                    onclick="document.getElementById('joinClassModal').style.display='none'"><i
                        data-lucide="x"></i></button>
            </div>
            <div class="dialog-content">
                <div style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Class Code</label>
                    <input type="text" name="code" required placeholder="e.g. XY12Z3"
                        style="width:100%; padding:0.5rem; border:1px solid hsl(var(--border)); border-radius:0.25rem; background:hsl(var(--background)); color:hsl(var(--foreground)); text-transform:uppercase;">
                    <p style="font-size:0.8rem; color:hsl(var(--muted-foreground)); margin-top:0.25rem;">Ask your
                        teacher for the class code.</p>
                </div>
            </div>
            <div class="dialog-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('joinClassModal').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-primary"
                    style="background:hsl(var(--primary)); color:hsl(var(--primary-foreground));">Join</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    function switchView(viewName) {
        // Hide all
        document.getElementById('classrooms-section').style.display = 'none';
        document.getElementById('projects-section').style.display = 'none';

        // Update pills
        document.querySelectorAll('.nav-pill-item').forEach(btn => btn.classList.remove('active'));

        // Show selected
        if (viewName === 'classrooms') {
            document.getElementById('classrooms-section').style.display = 'block';
            document.querySelector('button[onclick="switchView(\'classrooms\')"]').classList.add('active');
        } else {
            document.getElementById('projects-section').style.display = 'block';
            document.querySelector('button[onclick="switchView(\'projects\')"]').classList.add('active');
        }
    }

    // Initialize icons
    lucide.createIcons();

    let modelToDeleteId = null;
    const deleteModal = document.getElementById('delete-modal');
    const deleteNameSpan = document.getElementById('delete-model-name');
    const confirmBtn = document.getElementById('confirm-delete-btn');

    function confirmDelete(id, name) {
        modelToDeleteId = id;
        deleteNameSpan.textContent = name;
        deleteModal.hidden = false;
        // Also ensure appropriate display style if needed, though hidden usually overrides
        deleteModal.style.display = 'flex';
    }

    function closeDeleteModal() {
        deleteModal.hidden = true;
        deleteModal.style.display = 'none';
        modelToDeleteId = null;
    }

    confirmBtn.addEventListener('click', async () => {
        if (!modelToDeleteId) return;

        const originalText = confirmBtn.textContent;
        confirmBtn.textContent = 'Deleting...';
        confirmBtn.disabled = true;

        try {
            const res = await fetch(`/api/models/${modelToDeleteId}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                window.location.reload();
            } else {
                alert('Failed to delete model');
            }
        } catch (error) {
            console.error(error);
            alert('Error deleting model');
        } finally {
            confirmBtn.textContent = originalText;
            confirmBtn.disabled = false;
            closeDeleteModal();
        }
    });

    // Close on overlay click
    document.querySelectorAll('.dialog-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.hidden = true;
                overlay.style.display = 'none';
            }
        });
    });
</script>
<script src="{{ url_for('static', filename='js/theme.js') }}"></script>
{% endblock %}