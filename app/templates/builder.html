{% extends "base.html" %}

{% block title %}ML Pipeline Builder - GlideML{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/builder.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
{% endblock %}

{% block content %}
<div class="builder-page">
    <!-- Top Toolbar -->
    <div class="toolbar">
        <div class="toolbar-left">
            <a href="{{ url_for('main.landing') }}" class="logo-link">
                <div class="logo-box-small">ðŸ¤–</div>
                <span class="logo-text-small">GlideML</span>
            </a>
            
            <div class="toolbar-divider"></div>
            
            <button id="new-model-btn" class="btn btn-ghost btn-sm" title="New Model">
                <i data-lucide="file-plus"></i>
                <span class="hide-mobile">New</span>
            </button>
            
            <button id="save-model-btn" class="btn btn-ghost btn-sm" title="Save Model">
                <i data-lucide="save"></i>
                <span class="hide-mobile">Save</span>
            </button>
            
            <button id="load-model-btn" class="btn btn-ghost btn-sm" title="Load Model">
                <i data-lucide="folder-open"></i>
                <span class="hide-mobile">Open</span>
            </button>
            
            <button id="versions-btn" class="btn btn-ghost btn-sm hide-mobile" title="Version History">
                <i data-lucide="git-branch"></i>
                <span>Versions</span>
            </button>
            
            <button id="import-model-btn" class="btn btn-ghost btn-sm hide-mobile" title="Import JSON">
                <i data-lucide="upload"></i>
                <span>Import</span>
            </button>
            
            <div class="toolbar-divider"></div>
            
            <button id="undo-btn" class="btn btn-ghost btn-sm" title="Undo" disabled>
                <i data-lucide="undo"></i>
                <span class="hide-mobile">Undo</span>
            </button>
            
            <button id="redo-btn" class="btn btn-ghost btn-sm" title="Redo" disabled>
                <i data-lucide="redo"></i>
                <span class="hide-mobile">Redo</span>
            </button>
            
            <div class="toolbar-divider hide-mobile"></div>
            
            <button id="templates-btn" class="btn btn-ghost btn-sm hide-mobile" title="Templates">
                <i data-lucide="layout-template"></i>
                Templates
            </button>
            
            <button id="validate-btn" class="btn btn-ghost btn-sm hide-mobile" title="Validate Pipeline">
                <i data-lucide="check-circle"></i>
                Validate
            </button>
            
        </div>

        <div class="toolbar-right">
            <button id="export-model-btn" class="btn btn-ghost btn-sm hide-mobile">
                <i data-lucide="download"></i>
                <span>Export JSON</span>
            </button>
            
            <button id="export-code-btn" class="btn btn-primary btn-sm">
                <i data-lucide="code" style="margin-right: 3px;"></i>
                <span> Code</span>
            </button>

            <button id="export-btn" class="btn btn-primary btn-sm" title="Export Pipeline">
                <i data-lucide="package"></i>
                <span>Export</span>
            </button>
            
            <div class="toolbar-divider"></div>
            
            <button id="theme-toggle" class="btn btn-ghost btn-sm" aria-label="Toggle theme">
                <i data-lucide="moon" class="theme-icon"></i>
            </button>
            
            {% if current_user.is_authenticated %}
                <div class="user-menu">
                    <button id="user-menu-btn" class="btn btn-ghost btn-sm">
                        <div class="avatar avatar-sm">
                            <span>{{ current_user.username[0].upper() }}</span>
                        </div>
                        <span class="hide-mobile">{{ current_user.username }}</span>
                        <i data-lucide="chevron-down"></i>
                    </button>
                    
                    <div id="user-menu-dropdown" class="dropdown-menu" hidden>
                        <div class="dropdown-item disabled">
                            <i data-lucide="user"></i>
                            <span>{{ current_user.email }}</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a href="{{ url_for('auth.logout') }}" class="dropdown-item">
                            <i data-lucide="log-out"></i>
                            <span>Sign Out</span>
                        </a>
                    </div>
                </div>
            {% else %}
                <a href="{{ url_for('auth.login') }}" class="btn btn-outline btn-sm">
                    <i data-lucide="log-in"></i>
                    <span>Sign In</span>
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Main Content -->
    <div class="builder-container">
        <!-- Expand Sidebar Button (visible when collapsed) -->
        <button id="expand-sidebar-btn" class="expand-sidebar-btn" hidden>
            <i data-lucide="panel-left-open"></i>
        </button>
        
        <!-- Component Library Sidebar -->
        <aside class="component-sidebar" id="component-sidebar">
            <div class="sidebar-header">
                <h3 class="sidebar-title">Components</h3>
                <button id="toggle-sidebar-btn" class="btn btn-ghost btn-xs">
                    <i data-lucide="panel-left-close"></i>
                </button>
            </div>

            <div class="sidebar-search">
                <input 
                    type="text" 
                    id="component-search" 
                    class="form-input form-input-sm" 
                    placeholder="Search components..."
                >
                <i data-lucide="search" class="search-icon"></i>
            </div>

            <div class="sidebar-content">
                <!-- Component categories will be dynamically populated -->
                <div id="component-categories">
                    <div class="loading-state">
                        <i data-lucide="loader" class="spinner"></i>
                        <span>Loading components...</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Canvas Area -->
        <main class="canvas-area">
            <div class="canvas-wrapper">
                <!-- Canvas Controls -->
                <div class="canvas-controls">
                    <div class="canvas-zoom">
                        <button id="zoom-out-btn" class="btn btn-ghost btn-xs" title="Zoom Out">
                            <i data-lucide="zoom-out"></i>
                        </button>
                        <span id="zoom-level" class="zoom-text">100%</span>
                        <button id="zoom-in-btn" class="btn btn-ghost btn-xs" title="Zoom In">
                            <i data-lucide="zoom-in"></i>
                        </button>
                        <button id="zoom-fit-btn" class="btn btn-ghost btn-xs" title="Fit View">
                            <i data-lucide="maximize"></i>
                        </button>
                    </div>
                </div>

                <!-- Main Canvas -->
                <div id="canvas" class="canvas">
                    <svg id="canvas-svg" class="canvas-svg" width="100%" height="100%">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="#3b82f6" />
                            </marker>
                        </defs>
                    </svg>
                    <div id="canvas-nodes" class="canvas-nodes"></div>
                    
                    <!-- Empty State -->
                    <div id="empty-state" class="empty-state">
                        <div class="empty-icon">ðŸŽ¨</div>
                        <h3 class="empty-title">Start Building Your ML Pipeline</h3>
                        <p class="empty-text">
                            Drag components from the sidebar to begin, or choose a template to get started quickly.
                        </p>
                        <button id="empty-templates-btn" class="btn btn-outline">
                            <i data-lucide="layout-template"></i>
                            Browse Templates
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Property Panel -->
        <aside class="property-panel" id="property-panel" hidden>
            <div class="panel-header">
                <h3 class="panel-title">Properties</h3>
                <button id="close-properties-btn" class="btn btn-ghost btn-xs">
                    <i data-lucide="x"></i>
                </button>
            </div>

            <div class="panel-content">
                <div id="property-form">
                    <div class="empty-state-small">
                        <i data-lucide="mouse-pointer"></i>
                        <span>Select a node to edit properties</span>
                    </div>
                </div>
            </div>

            <div class="panel-footer">
                <button id="delete-node-btn" class="btn btn-error btn-sm btn-full" hidden>
                    <i data-lucide="trash-2"></i>
                    Delete Node
                </button>
            </div>
        </aside>
    </div>

    <!-- Modals -->
    
    <!-- Save Model Dialog -->
    <div id="save-dialog" class="dialog-overlay" hidden>
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Save Model</h3>
                <button class="dialog-close" data-close-dialog="save-dialog">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="dialog-content">
                <div class="form-group">
                    <label for="model-name" class="form-label">Model Name</label>
                    <input 
                        type="text" 
                        id="model-name" 
                        class="form-input" 
                        placeholder="My ML Pipeline"
                        required
                    >
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-ghost" data-close-dialog="save-dialog">Cancel</button>
                <button id="confirm-save-btn" class="btn btn-primary">
                    <i data-lucide="save"></i>
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Load Model Dialog -->
    <div id="load-dialog" class="dialog-overlay" hidden>
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Open Model</h3>
                <button class="dialog-close" data-close-dialog="load-dialog">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="dialog-content">
                <div id="saved-models-list">
                    <div class="loading-state">
                        <i data-lucide="loader" class="spinner"></i>
                        <span>Loading saved models...</span>
                    </div>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-ghost" data-close-dialog="load-dialog">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Templates Dialog -->
    <div id="templates-dialog" class="dialog-overlay" hidden>
        <div class="dialog dialog-lg">
            <div class="dialog-header">
                <h3 class="dialog-title">Pipeline Templates</h3>
                <button class="dialog-close" data-close-dialog="templates-dialog">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="dialog-content">
                <div id="templates-grid">
                    <div class="loading-state">
                        <i data-lucide="loader" class="spinner"></i>
                        <span>Loading templates...</span>
                    </div>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-ghost" data-close-dialog="templates-dialog">Close</button>
            </div>
        </div>
    </div>

    <!-- Export Code Dialog -->
    <div id="export-dialog" class="dialog-overlay" hidden>
        <div class="dialog dialog-lg">
            <div class="dialog-header">
                <h3 class="dialog-title">Export Python Code</h3>
                <button class="dialog-close" data-close-dialog="export-dialog">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="dialog-content">
                <div id="export-code-container">
                    <pre id="export-code-display" class="code-block"></pre>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-ghost" data-close-dialog="export-dialog">Close</button>
                <button id="copy-code-btn" class="btn btn-primary">
                    <i data-lucide="copy"></i>
                    Copy Code
                </button>
            </div>
        </div>
    </div>

    <!-- Import Model Dialog -->
    <div id="import-dialog" class="dialog-overlay" hidden>
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Import Model</h3>
                <button class="dialog-close" data-close-dialog="import-dialog">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="dialog-content">
                <p class="text-muted">Import a previously exported model or paste JSON data</p>
                <textarea id="import-json-input" class="form-textarea" rows="10" placeholder='{"nodes": [...], "edges": [...]}'></textarea>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-ghost" data-close-dialog="import-dialog">Cancel</button>
                <button id="confirm-import-btn" class="btn btn-primary">
                    <i data-lucide="upload"></i>
                    Import
                </button>
            </div>
        </div>
    </div>

    <!-- Validation Results Dialog -->
    <div id="validation-dialog" class="dialog-overlay" hidden>
        <div class="dialog dialog-wide">
            <div class="dialog-header">
                <h3 class="dialog-title">Model Analysis & Validation</h3>
                <button class="dialog-close" data-close-dialog="validation-dialog">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="dialog-content">
                <p class="text-muted">Review your model's structure, statistics, and potential issues</p>
                
                <div class="validation-grid">
                    <div class="validation-section">
                        <h4 class="validation-section-title">Model Statistics</h4>
                        <div id="model-statistics"></div>
                    </div>
                    
                    <div class="validation-section">
                        <h4 class="validation-section-title">Validation Results <i data-lucide="check-circle" class="text-success"></i></h4>
                        <div id="validation-results"></div>
                    </div>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-primary" data-close-dialog="validation-dialog">OK</button>
            </div>
        </div>
    </div>

    <!-- Version History Dialog -->
    <div id="versions-dialog" class="dialog-overlay" hidden>
        <div class="dialog dialog-lg">
            <div class="dialog-header">
                <h3 class="dialog-title">Version History</h3>
                <button class="dialog-close" data-close-dialog="versions-dialog">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="dialog-content">
                <div style="margin-bottom: 1rem;">
                    <button id="create-version-btn" class="btn btn-primary btn-sm">
                        <i data-lucide="plus"></i>
                        Create New Version
                    </button>
                </div>
                
                <div id="versions-list">
                    <div class="loading-state">
                        <i data-lucide="loader" class="spinner"></i>
                        <span>Loading versions...</span>
                    </div>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-ghost" data-close-dialog="versions-dialog">Close</button>
            </div>
        </div>
    </div>

    <!-- Export Formats Dialog (Phase 3) -->
    <div id="export-formats-dialog" class="dialog-overlay" hidden>
        <div class="dialog">
            <div class="dialog-header">
                <h3 class="dialog-title">Export Pipeline</h3>
                <button class="dialog-close" data-close-dialog="export-formats-dialog">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="dialog-content">
                <p class="text-sm text-muted mb-4">Choose an export format for your ML pipeline:</p>
                
                <div class="export-options">
                    <!-- Python Script -->
                    <button class="export-option-card" data-export-format="python">
                        <div class="export-option-icon">
                            <i data-lucide="file-code"></i>
                        </div>
                        <div class="export-option-content">
                            <h4>Python Script</h4>
                            <p>Standalone executable Python script with CLI support and error handling</p>
                        </div>
                        <div class="export-option-arrow">
                            <i data-lucide="arrow-right"></i>
                        </div>
                    </button>

                    <!-- Jupyter Notebook -->
                    <button class="export-option-card" data-export-format="notebook">
                        <div class="export-option-icon">
                            <i data-lucide="notebook"></i>
                        </div>
                        <div class="export-option-content">
                            <h4>Jupyter Notebook</h4>
                            <p>Interactive notebook with step-by-step cells and documentation</p>
                        </div>
                        <div class="export-option-arrow">
                            <i data-lucide="arrow-right"></i>
                        </div>
                    </button>

                    <!-- Docker Container -->
                    <button class="export-option-card" data-export-format="docker">
                        <div class="export-option-icon">
                            <i data-lucide="container"></i>
                        </div>
                        <div class="export-option-content">
                            <h4>Docker Container</h4>
                            <p>Complete Docker setup with Dockerfile, compose, and deployment docs</p>
                        </div>
                        <div class="export-option-arrow">
                            <i data-lucide="arrow-right"></i>
                        </div>
                    </button>

                    <!-- Requirements.txt -->
                    <button class="export-option-card" data-export-format="requirements">
                        <div class="export-option-icon">
                            <i data-lucide="package"></i>
                        </div>
                        <div class="export-option-content">
                            <h4>Requirements</h4>
                            <p>Python dependencies list with pinned versions</p>
                        </div>
                        <div class="export-option-arrow">
                            <i data-lucide="arrow-right"></i>
                        </div>
                    </button>
                </div>
            </div>
            <div class="dialog-footer">
                <button class="btn btn-ghost" data-close-dialog="export-formats-dialog">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/theme.js') }}"></script>
<script src="{{ url_for('static', filename='js/history.js') }}"></script>
<script src="{{ url_for('static', filename='js/api.js') }}"></script>
<script src="{{ url_for('static', filename='js/components.js') }}"></script>
<script src="{{ url_for('static', filename='js/properties.js') }}"></script>
<script src="{{ url_for('static', filename='js/canvas.js') }}"></script>
<script src="{{ url_for('static', filename='js/versions.js') }}"></script>
<script src="{{ url_for('static', filename='js/export.js') }}"></script>
<script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Initialize builder on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize all components
        window.canvasInit();
        window.componentsInit();
        
        // Initialize export manager
        if (window.ExportManager) {
            window.ExportManager.init();
        }
        
        // User menu toggle
        const userMenuBtn = document.getElementById('user-menu-btn');
        const userMenuDropdown = document.getElementById('user-menu-dropdown');
        
        if (userMenuBtn && userMenuDropdown) {
            userMenuBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                userMenuDropdown.hidden = !userMenuDropdown.hidden;
            });
            
            document.addEventListener('click', function() {
                userMenuDropdown.hidden = true;
            });
        }

        // Dialog management
        document.querySelectorAll('[data-close-dialog]').forEach(btn => {
            btn.addEventListener('click', function() {
                const dialogId = this.getAttribute('data-close-dialog');
                const dialog = document.getElementById(dialogId);
                if (dialog) dialog.hidden = true;
            });
        });

        // Close dialogs on overlay click
        document.querySelectorAll('.dialog-overlay').forEach(overlay => {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.hidden = true;
                }
            });
        });
    });
</script>
{% endblock %}
