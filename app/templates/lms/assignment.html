{% extends "base.html" %}

{% block title %}{{ work.title }} - {{ work.classroom.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
    /* Assignment Specific Styles */
    .work-header {
        background: hsl(var(--card));
        border-bottom: 1px solid hsl(var(--border));
        padding: 2rem 0;
        margin-bottom: 2rem;
    }

    .work-title {
        font-size: 2rem;
        font-weight: 700;
        color: hsl(var(--foreground));
        margin-bottom: 0.5rem;
    }

    .work-meta {
        color: hsl(var(--muted-foreground));
        font-size: 0.9rem;
        display: flex;
        gap: 1.5rem;
        align-items: center;
    }

    .work-icon-large {
        width: 48px;
        height: 48px;
        background: hsl(var(--primary));
        color: hsl(var(--primary-foreground));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .content-card {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius-lg);
        padding: 2rem;
        margin-bottom: 2rem;
    }

    .submission-card {
        background: hsl(var(--card));
        border: 1px solid hsl(var(--border));
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        height: 100%;
    }

    .submission-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-assigned {
        background: hsl(var(--muted));
        color: hsl(var(--muted-foreground));
    }

    .status-turned_in {
        background: #dcfce7;
        color: #166534;
    }

    .status-graded {
        background: #dbeafe;
        color: #1e40af;
    }

    /* Teacher Grading Table */
    .grading-table {
        width: 100%;
        border-collapse: collapse;
    }

    .grading-table th {
        text-align: left;
        padding: 1rem;
        color: hsl(var(--muted-foreground));
        font-weight: 500;
        border-bottom: 1px solid hsl(var(--border));
    }

    .grading-table td {
        padding: 1rem;
        border-bottom: 1px solid hsl(var(--border));
        color: hsl(var(--foreground));
    }

    .grading-input {
        width: 60px;
        padding: 0.25rem;
        border: 1px solid hsl(var(--border));
        border-radius: 4px;
        background: hsl(var(--background));
        color: hsl(var(--foreground));
    }

    /* Markdown Content */
    .markdown-body {
        color: hsl(var(--foreground));
        line-height: 1.6;
    }

    .markdown-body h1,
    .markdown-body h2,
    .markdown-body h3 {
        margin-top: 1.5rem;
        margin-bottom: 1rem;
    }

    .markdown-body p {
        margin-bottom: 1rem;
    }

    .markdown-body code {
        background: hsl(var(--muted));
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: monospace;
    }

    .markdown-body pre {
        background: hsl(var(--muted));
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
    }
</style>
{% endblock %}

{% block content %}
<div style="background: hsl(var(--background)); min-height: 100vh;">
    <!-- Header -->
    <header class="work-header">
        <div class="container">
            <div style="display: flex; gap: 1.5rem; align-items: flex-start;">
                <div class="work-icon-large">
                    <i data-lucide="{{ 'flask-conical' if work.type == 'lab' else 'file-text' }}" width="28"
                        height="28"></i>
                </div>
                <div style="flex: 1;">
                    <h1 class="work-title">{{ work.title }}</h1>
                    <div class="work-meta">
                        <span>{{ work.classroom.owner.display_name or work.classroom.owner.username }}</span>
                        <span>•</span>
                        <span>{{ work.created_at.strftime('%b %d, %Y') }}</span>
                        <span>•</span>
                        <span>{{ "100 points" }}</span>
                    </div>
                </div>

                <div style="display: flex; gap: 0.5rem;">
                    {# PDF Export removed as requested #}
                    {% if is_teacher %}
                    <button onclick="document.getElementById('editWorkModal').style.display='flex'"
                        class="btn btn-secondary" title="Edit Content">
                        <i data-lucide="edit-3"></i> <span class="hide-mobile">Edit</span>
                    </button>
                    <form action="{{ url_for('lms.delete_classwork', cw_id=work.id) }}" method="POST"
                        style="display:inline;"
                        onsubmit="return confirm('Are you sure you want to delete this assignment? All submissions will be lost.');">
                        <button type="submit" class="btn btn-outline"
                            style="color: hsl(var(--destructive)); border-color: hsl(var(--border));" title="Delete">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </form>
                    {% endif %}
                    <a href="{{ url_for('lms.classroom_view', class_id=work.classroom.id) }}" class="btn btn-outline">
                        <i data-lucide="arrow-left"></i> Back to Class
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container padding-bottom-4">
        <div class="row" style="display: flex; gap: 2rem; flex-wrap: wrap;">

            <!-- LEFT COLUMN: Instructions -->
            <div style="flex: 1; min-width: 0;">
                <div class="content-card">
                    <div id="instruction-content" class="markdown-body">
                        <!-- Content will be rendered by JS -->
                        <div id="raw-content" style="display:none;">{{ work.content_text or work.description or "No
                            instructions provided." }}</div>
                        <div class="loading-spinner">Loading content...</div>
                    </div>

                    {% if work.type == 'lab' and work.lab_model_id %}
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid hsl(var(--border));">
                        <h4 style="margin-bottom: 1rem;">Attached Lab Pipeline</h4>
                        <div class="model-card" style="margin: 0;">
                            <div class="model-header">
                                <i data-lucide="workflow" style="color: hsl(var(--primary));"></i>
                            </div>
                            <div class="model-name">Starting Template</div>
                            <p class="model-desc">Use this pipeline as a starting point for your lab.</p>
                            <div class="model-footer">
                                <a href="{{ url_for('main.builder', modelId=work.lab_model_id) }}" target="_blank"
                                    class="btn btn-primary btn-sm btn-full">
                                    Open Lab Template
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- RIGHT COLUMN: Submission / Grading -->
            <div style="width: 350px;">
                {% if is_teacher %}
                <!-- TEACHER VIEW -->
                {% if work.type in ['assignment', 'lab'] %}
                <div class="submission-card">
                    <h3 style="margin-top: 0; margin-bottom: 1rem;">Student Work</h3>

                    <!-- Filters -->
                    <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                        <button onclick="filterSubmissions('all')" class="btn btn-xs btn-outline active-filter"
                            id="filter-all">All</button>
                        <button onclick="filterSubmissions('turned_in')" class="btn btn-xs btn-outline"
                            id="filter-turned_in">Turned In</button>
                        <button onclick="filterSubmissions('missing')" class="btn btn-xs btn-outline"
                            id="filter-missing">Missing</button>
                    </div>

                    <div
                        style="display: flex; justify-content: space-between; margin-bottom: 1rem; color: hsl(var(--muted-foreground));">
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: hsl(var(--foreground));">{{
                                work.submissions.count() }}</div>
                            <div style="font-size: 0.8rem;">Turned In</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: hsl(var(--foreground));">{{
                                work.classroom.enrollments.count() - work.submissions.count() }}</div>
                            <div style="font-size: 0.8rem;">Assigned</div>
                        </div>
                    </div>

                    <div style="max-height: 400px; overflow-y: auto;" id="student-list">
                        {% for enrollment in work.classroom.enrollments %}
                        {% set sub = work.submissions.filter_by(student_id=enrollment.user_id).first() %}
                        <div class="student-row" data-status="{{ 'turned_in' if sub else 'missing' }}"
                            style="padding: 1rem 0; border-top: 1px solid hsl(var(--border));">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <div
                                    style="width: 24px; height: 24px; border-radius: 50%; background: hsl(var(--muted)); display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                                    {{ enrollment.user.username[0]|upper }}
                                </div>
                                <span style="font-weight: 500;">{{ enrollment.user.display_name or
                                    enrollment.user.username }}</span>
                            </div>

                            {% if sub %}
                            <div
                                style="background: hsl(var(--muted)); padding: 0.5rem; border-radius: 4px; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                {% if sub.submission_model_id %}
                                <a href="{{ url_for('main.builder', modelId=sub.submission_model_id) }}"
                                    target="_blank">View Pipeline <i data-lucide="external-link"
                                        style="width: 12px;"></i></a>
                                {% else %}
                                {{ sub.feedback or "No content submitted" }}
                                {% endif %}
                            </div>
                            <form action="{{ url_for('lms.grade_submission', sub_id=sub.id) }}" method="POST"
                                style="display: flex; gap: 0.5rem;">
                                <input type="number" name="grade" placeholder="/100" value="{{ sub.grade or '' }}"
                                    class="grading-input" max="100">
                                <button type="submit" class="btn btn-primary btn-xs">Return</button>
                            </form>
                            {% else %}
                            <span class="text-muted small">Missing</span>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>

                </div>
            </div>
            {% endif %}

            {% else %}
            <!-- STUDENT VIEW -->
            {% if work.type in ['assignment', 'lab'] %}
            <div class="submission-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">Your Work</h3>
                    {% if submission %}
                    <span class="submission-status status-{{ submission.status }}">{{ submission.status.replace('_',
                        ' ') }}</span>
                    {% else %}
                    <span class="submission-status status-assigned">Assigned</span>
                    {% endif %}
                </div>

                {% if submission %}
                <div style="margin-bottom: 1.5rem;">
                    {% if submission.grade is not none %}
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div style="font-size: 2.5rem; font-weight: 700;">{{ submission.grade }}/100</div>
                        <div style="color: hsl(var(--muted-foreground));">Grade</div>
                    </div>
                    {% endif %}

                    <p style="font-weight: 500; margin-bottom: 0.5rem;">Submitted:</p>
                    <div
                        style="background: hsl(var(--muted)); padding: 1rem; border-radius: var(--radius); margin-bottom: 1rem;">
                        {% if submission.submission_model_id %}
                        <a href="{{ url_for('main.builder', modelId=submission.submission_model_id) }}" target="_blank"
                            style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none; color: hsl(var(--foreground));">
                            <i data-lucide="workflow"></i>
                            <span>View Submitted Pipeline</span>
                        </a>
                        {% else %}
                        {{ submission.feedback }}
                        <!-- Using feedback field for text submission temporarily if used -->
                        {% endif %}
                    </div>
                    <button class="btn btn-outline btn-full" disabled>Unsubmit</button>
                </div>
                {% else %}
                <form action="{{ url_for('lms.submit_assignment', cw_id=work.id) }}" method="POST">
                    <div
                        style="margin-bottom: 1rem; background: hsl(var(--muted)); padding: 1rem; border-radius: var(--radius);">
                        <div style="margin-bottom: 1rem;">
                            <label
                                style="display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;">Select
                                Pipeline to Submit</label>

                            {% if current_user.models.count() > 0 %}
                            <select name="model_id" class="form-select"
                                style="width: 100%; padding: 0.5rem; border: 1px solid hsl(var(--border)); border-radius: 4px;"
                                required>
                                <option value="">Choose a pipeline...</option>
                                {% for model in current_user.models %}
                                <option value="{{ model.id }}">{{ model.name }}</option>
                                {% endfor %}
                            </select>
                            {% else %}
                            <p class="text-muted small" style="margin-bottom:0.5rem;">You haven't created any pipelines
                                yet.</p>
                            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline btn-sm btn-full"
                                target="_blank">Go to Builder</a>
                            {% endif %}
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full" {{ 'disabled' if
                        current_user.models.count()==0 else '' }}>
                        <i data-lucide="check-circle" style="width:16px; margin-right:5px;"></i> Turn In
                    </button>
                </form>
                {% endif %}
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>
</div>

<!-- Edit Content Modal (Teacher Only) -->
{% if is_teacher %}
<div id="editWorkModal" class="dialog-overlay" style="display:none;">
    <div class="dialog" style="max-width:800px;">
        <form action="{{ url_for('lms.edit_classwork', cw_id=work.id) }}" method="POST">
            <div class="dialog-header">
                <h3>Edit Content</h3>
                <button type="button" class="dialog-close"
                    onclick="document.getElementById('editWorkModal').style.display='none'"><i
                        data-lucide="x"></i></button>
            </div>
            <div class="dialog-content">
                <div style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Title</label>
                    <input type="text" name="title" value="{{ work.title }}" required
                        style="width:100%; padding:0.5rem; border:1px solid hsl(var(--border)); border-radius:0.25rem; background:hsl(var(--background)); color:hsl(var(--foreground));">
                </div>
                <div style="margin-bottom:1rem;">
                    <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Content (Markdown +
                        LaTeX)</label>
                    <textarea name="content" rows="12"
                        style="width:100%; padding:0.5rem; border:1px solid hsl(var(--border)); border-radius:0.25rem; background:hsl(var(--background)); color:hsl(var(--foreground)); font-family:monospace;">{{ work.content_text or work.description }}</textarea>
                    <p class="text-muted small">Supports Markdown and LaTeX (e.g., $E=mc^2$)</p>
                </div>
            </div>
            <div class="dialog-footer">
                <button type="button" class="btn btn-secondary"
                    onclick="document.getElementById('editWorkModal').style.display='none'">Cancel</button>
                <button type="submit" class="btn btn-primary"
                    style="background:hsl(var(--primary)); color:hsl(var(--primary-foreground));">Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/theme.js') }}"></script>
<!-- MathJax -->
<script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        svg: {
            fontCache: 'global'
        }
    };
</script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    lucide.createIcons();

    // Render Markdown + LaTex
    document.addEventListener('DOMContentLoaded', () => {
        const rawContent = document.getElementById('raw-content').innerText;
        const targetDiv = document.getElementById('instruction-content');

        // Render Markdown
        if (typeof marked !== 'undefined') {
            targetDiv.innerHTML = marked.parse(rawContent);
        } else {
            targetDiv.innerHTML = rawContent.replace(/\n/g, '<br>');
        }

        // Trigger MathJax typeset after markdown is rendered
        if (window.MathJax) {
            window.MathJax.typesetPromise([targetDiv]).catch((err) => console.log('MathJax error:', err));
        }
    });

    // Close dialogs logic
    document.querySelectorAll('.dialog-overlay').forEach(overlay => {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.style.display = 'none';
            }
        });
    });

    function filterSubmissions(status) {
        // Init rows
        const rows = document.querySelectorAll('.student-row');
        rows.forEach(row => {
            if (status === 'all') {
                row.style.display = 'block';
            } else {
                if (row.dataset.status === status) {
                    row.style.display = 'block';
                } else {
                    row.style.display = 'none';
                }
            }
        });

        // Update active buttons
        document.querySelectorAll('[id^="filter-"]').forEach(btn => {
            btn.classList.remove('active-filter');
            if (status === 'all' && btn.id === 'filter-all') btn.classList.add('active-filter'); // basic highlight
            // (better styling could be applied here)
            if (btn.id === 'filter-' + status) {
                btn.classList.add('bg-primary');
                btn.classList.add('text-white');
            } else {
                btn.classList.remove('bg-primary');
                btn.classList.remove('text-white');
            }
        });
    }
</script>
{% endblock %}